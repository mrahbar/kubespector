image: endianogino/golang-glide:1.9-dep

stages:
  - build

before_script:
  - mkdir -p /go/src/github.com/mrahbar
  - cp -r /builds/mrahbar/kubernetes-inspector /go/src/github.com/mrahbar
  - cd /go/src/github.com/mrahbar/kubernetes-inspector
  
build-project:
  stage: build
  script:
    - export GOOS=linux
    - export CGO_ENABLED=0
    - BUILD_DATE=$(date -u)
    - TAG=$(grep -Po 'TAG\s=\s\K([\d.\-\w]+)' Makefile)
    - GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
    - GIT_COMMIT=$(git rev-parse HEAD)
    - echo "$TAG"
    - dep ensure -v
    - go build -a -installsuffix cgo -ldflags "-w -X main.version=$TAG -X 'main.buildDate=$BUILD_DATE' -X main.branch=$GIT_BRANCH -X main.commit=$GIT_COMMIT" -o kubespector-$TAG *.go
    - mv kubespector-$TAG /builds/mrahbar/kubernetes-inspector
  artifacts:
    when: on_success
    paths:
    - kubespector-*
    
